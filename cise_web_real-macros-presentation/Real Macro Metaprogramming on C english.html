<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1561.6">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 41.0px; font: 36.0px Times; color: #000000}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 41.0px; font: 36.0px Times; color: #000000; min-height: 43.0px}
    p.p3 {margin: 0.0px 0.0px 48.2px 0.0px; line-height: 83.0px; font: 72.0px Times; color: #000000}
    p.p4 {margin: 0.0px 0.0px 44.8px 0.0px; line-height: 63.0px; font: 54.0px Times; color: #000000}
    p.p5 {margin: 0.0px 0.0px 42.1px 0.0px; line-height: 49.0px; font: 42.1px Times; color: #000000; min-height: 52.0px}
    p.p6 {margin: 0.0px 0.0px 47.9px 0.0px; line-height: 41.0px; font: 36.0px Times; color: #000000; min-height: 43.0px}
    p.p7 {margin: 0.0px 0.0px 48.2px 0.0px; line-height: 83.0px; font: 72.0px Times; color: #000000; min-height: 86.0px}
    p.p8 {margin: 0.0px 0.0px 36.0px 0.0px; line-height: 41.0px; font: 36.0px Times; color: #000000; min-height: 43.0px}
    p.p9 {margin: 0.0px 0.0px 36.0px 0.0px; line-height: 41.0px; font: 36.0px Times; color: #000000}
    p.p10 {margin: 0.0px 0.0px 72.0px 0.0px; text-align: center; line-height: 83.0px; font: 72.0px Times; color: #000000}
    p.p11 {margin: 0.0px 0.0px 0.0px 0.0px; text-align: center; line-height: 14.0px; font: 12.0px Times; color: #000000}
    p.p12 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px Courier; color: #000000}
    p.p13 {margin: 0.0px 0.0px 0.0px 0.0px; text-align: right; line-height: 14.0px; font: 12.0px Times; color: #000000}
    p.p14 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px Times; color: #000000}
    p.p15 {margin: 0.0px 0.0px 36.0px 0.0px; line-height: 41.0px; font: 36.0px Courier; color: #000000}
    p.p16 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 41.0px; font: 36.0px Courier; color: #000000}
    p.p17 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 41.0px; font: 36.0px Courier; color: #000000; min-height: 43.0px}
    p.p18 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 41.0px; font: 36.0px Courier; color: #000000; background-color: #ddffdd}
    p.p19 {margin: 0.0px 0.0px 36.0px 0.0px; line-height: 41.0px; font: 36.0px Symbol; color: #000000}
    p.p20 {margin: 0.0px 0.0px 0.0px 0.0px; text-align: center; line-height: 14.0px; font: 12.0px Times; color: #000000; min-height: 14.0px}
    p.p21 {margin: 0.0px 0.0px 72.0px 0.0px; text-align: center; line-height: 83.0px; font: 72.0px Times; color: #ff0000}
    p.p22 {margin: 0.0px 0.0px 43.2px 0.0px; line-height: 49.0px; font: 43.2px Times; color: #000000}
    p.p23 {margin: 0.0px 0.0px 36.0px 0.0px; text-align: right; line-height: 41.0px; font: 36.0px Times; color: #000000}
    li.li1 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 41.0px; font: 36.0px Times; color: #000000}
    li.li9 {margin: 0.0px 0.0px 36.0px 0.0px; line-height: 41.0px; font: 36.0px Times; color: #000000}
    li.li16 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 41.0px; font: 36.0px Courier; color: #000000}
    span.s1 {font-kerning: none}
    span.s2 {font: 72.0px Times; font-kerning: none}
    span.s3 {font: 36.0px Times}
    span.s4 {font: 36.0px Times; font-kerning: none}
    span.s5 {font: 36.0px Courier}
    span.s6 {font: 36.0px Courier; font-kerning: none}
    span.s7 {font: 36.0px Monaco; font-kerning: none}
    span.s8 {font: 36.0px Symbol; font-kerning: none}
    table.t1 {border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080}
    td.td1 {width: 57.6px; margin: 0.5px 0.5px 0.5px 0.5px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080; padding: 1.0px 1.0px 1.0px 1.0px}
    td.td2 {width: 53.0px; margin: 0.5px 0.5px 0.5px 0.5px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080; padding: 1.0px 1.0px 1.0px 1.0px}
    td.td3 {width: 31.0px; margin: 0.5px 0.5px 0.5px 0.5px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080; padding: 1.0px 1.0px 1.0px 1.0px}
    td.td4 {width: 33.8px; margin: 0.5px 0.5px 0.5px 0.5px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080; padding: 1.0px 1.0px 1.0px 1.0px}
    td.td5 {width: 27.3px; margin: 0.5px 0.5px 0.5px 0.5px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080; padding: 1.0px 1.0px 1.0px 1.0px}
    ol.ol1 {list-style-type: decimal}
    ul.ul1 {list-style-type: none}
    ul.ul2 {list-style-type: disc}
    ul.ul3 {list-style-type: circle}
  </style>
</head>
<body>
<p class="p1"><span class="s1">2 / 24</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p3"><span class="s1"><b>Dramatic Before after @ LLTV</b></span></p>
<p class="p4"><span class="s1"><b>Real Macro Metaprogramming on C</b></span></p>
<p class="p3"><span class="s1"><b><br>
</b></span></p>
<p class="p5"><span class="s1"><b></b></span><br></p>
<p class="p6"><span class="s1"><b></b></span><br></p>
<p class="p7"><span class="s1"><b></b></span><br></p>
<p class="p8"><span class="s1"></span><br></p>
<ul class="ul1">
  <li class="li9"><span class="s1"><br>
</span></li>
  <li class="li9"><span class="s1"><br>
</span></li>
  <li class="li9"><span class="s1"><br>
</span></li>
  <li class="li9"><span class="s1"><br>
</span></li>
</ul>
<p class="p7"><span class="s1"><b></b></span><br></p>
<p class="p10"><span class="s1"><b>Genuine</b> macro breakthrough abstraction limit</span></p>
<p class="p10"><span class="s1">(false macro of! cpp)</span></p>
<p class="p3"><span class="s1"><b>Subject</b></span></p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td1">
        <p class="p11"><span class="s1"><b>File</b></span></p>
      </td>
      <td valign="middle" class="td2">
        <p class="p11"><span class="s1"><b>LOC</b></span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td1">
        <p class="p12"><span class="s1">ls.h</span></p>
      </td>
      <td valign="middle" class="td2">
        <p class="p13"><span class="s1">38</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td1">
        <p class="p12"><span class="s1">extern.h</span></p>
      </td>
      <td valign="middle" class="td2">
        <p class="p13"><span class="s1">twenty one</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td1">
        <p class="p12"><span class="s1">ls.c</span></p>
      </td>
      <td valign="middle" class="td2">
        <p class="p13"><span class="s1">526</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td1">
        <p class="p12"><span class="s1">cmp.c</span></p>
      </td>
      <td valign="middle" class="td2">
        <p class="p13"><span class="s1">73</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td1">
        <p class="p12"><span class="s1">print.c</span></p>
      </td>
      <td valign="middle" class="td2">
        <p class="p13"><span class="s1">319</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td1">
        <p class="p12"><span class="s1">util.c</span></p>
      </td>
      <td valign="middle" class="td2">
        <p class="p13"><span class="s1">164</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td1">
        <p class="p14"><span class="s1">Total</span></p>
      </td>
      <td valign="middle" class="td2">
        <p class="p13"><span class="s1">1141</span></p>
      </td>
    </tr>
  </tbody>
</table>
<ul class="ul2">
  <li class="li9"><span class="s1">Anyone knows the </span><span class="s2">ls (1)</span><span class="s1"> command<br>
</span></li>
  <li class="li9"><span class="s1">Source is (Free, no-dependency) from FreeBSD<br>
</span></li>
  <li class="li9"><span class="s1">A straightforward and easy-to-read code<br>
</span></li>
  <li class="li9"><span class="s1">Honors <b>as a C language source</b><br>
</span></li>
</ul>
<p class="p10"><span class="s1">However…</span></p>
<p class="p7"><span class="s1"><b></b></span><br></p>
<p class="p10"><span class="s1">Three problems</span></p>
<p class="p3"><span class="s1"><b>Problem 1 - Redundant code</b></span></p>
<p class="p15"><span class="s1">cmp.c</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>int namecmp (const FTSENT * a, const FTSENT * b)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>{</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>return (strcoll (a -&gt; fts_name, b -&gt; fts_name));</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>}</span></p>
<p class="p17"><span class="s1"></span><br></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>int revnamecmp (const FTSENT * a, const FTSENT * b)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>{</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>return (strcoll (b -&gt; fts_name, a -&gt; fts_name));</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>}</span></p>
<p class="p3"><span class="s1"><b>Problem 1 - Redundant code (cont' d)</b></span></p>
<p class="p15"><span class="s1">util.c</span></p>
<ul class="ul2">
  <li class="li16"><span class="s3"></span><span class="s4">Four functions of the same structure</span><span class="s1"> while ((clen = mbrtowc (&amp; wc, ...))! = 0) {</span></li>
  <li class="li16"><span class="s1"> <span class="Apple-converted-space">    </span>if (clen == (size_t) -1) {...}</span></li>
  <li class="li16"><span class="s1"> <span class="Apple-converted-space">    </span>else if (clen == (size_t) -2)) {...}</span></li>
  <li class="li16"><span class="s1"> <span class="Apple-converted-space">    </span>if (iswprint (wc)) {...}</span></li>
  <li class="li16"><span class="s1"> <span class="Apple-converted-space">    </span>else {...}</span></li>
  <li class="li16"><span class="s1"> }</span></li>
  <li class="li16"><span class="s1"><br>
</span></li>
  <li class="li1"><span class="s1">In C, it is difficult to enclose common structure</span></li>
  <ul class="ul3">
    <li class="li1"><span class="s5"></span><span class="s6">It</span><span class="s1"> is necessary to refer to the outside environment from within the </span><span class="s6">while</span></li>
    <li class="li1"><span class="s1">But I can not use closures!</span></li>
  </ul>
</ul>
<p class="p3"><span class="s1"><b>Problem 2 - Nonessential information</b></span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space"> </span>int i;</span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space">    </span>:</span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space"> </span>for (i = 0; i &lt;(int) clen; i ++)</span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space">     </span>putchar ((unsigned char) s [i]);</span></p>
<p class="p15"><span class="s4">I wish I could write </span><span class="s1">for (int i = [0..clen]) {putchar (...)}</span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space"> </span>FTSENT * p;</span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space">    </span>:</span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space"> </span>for (p = dp -&gt; list; p; p = p -&gt; fts_link) {</span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space">    </span>:</span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space"> </span>}</span></p>
<p class="p15"><span class="s4">I wish I could write </span><span class="s1">foreach (FTSENT * p in dp -&gt; list) {...}</span></p>
<p class="p3"><span class="s1"><b>Problem 3 - Distribution of information</b></span></p>
<p class="p15"><span class="s1">ls.h</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>extern int f_accesstime; / * use time of last access * /</span></p>
<p class="p15"><span class="s1">ls. c (decl)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>int f_accesstime; / * use time of last access * /</span></p>
<p class="p15"><span class="s1">ls. c (main)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>case 'c':</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>f_statustime = 1;</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>f_accesstime = 0;</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>case 'u':</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>f_accesstime = 1;</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>f_statustime = 0;</span></p>
<p class="p3"><span class="s1"><b>Takumi's policy</b></span></p>
<p class="p9"><span class="s1">The point of renovation: The syntax is decorative</span></p>
<ul class="ul2">
  <li class="li16"><span class="s1">printf ("% d:% s \ n", n, msg);</span></li>
  <li class="li16"><span class="s1">(printf "% d:% s \ n" n msg)</span></li>
</ul>
<ul class="ul2">
  <li class="li16"><span class="s1">if (is_foo (x)) {do_foo (x);} else {do_bar (x);</span></li>
  <li class="li16"><span class="s1">(if (is _ foo x) (do _ foo x) (do_bar x))</span></li>
</ul>
<p class="p3"><span class="s1"><b>CiSE (C in S-Expression)</b></span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>int</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>main (int argc, char * argv [])</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>{</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>static char dot [] = ".", * dotav [] = {dot, NULL};</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>struct winsize win;</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>int ch, fts_options, notused;</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>char * p;</span></p>
<p class="p17"><span class="s1"></span><br></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>(void) setlocale (LC_ALL, "");</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>if (isatty (STDOUT_FILENO)) {</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">         </span>termwidth = 80;</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">         </span>if ((p = getenv ("COLUMNS"))! = NULL &amp;&amp; * p! = '\ 0')</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">             </span>termwidth = atoi (p);</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">         </span>else if (ioctl (STDOUT_FILENO, TIOCGWINSZ, &amp; win)! = -1 &amp;&amp;</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">                  </span>win.ws_col&gt; 0)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">             </span>termwidth = win.ws_col;</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">         </span>f_nonprint = 1;</span></p>
<p class="p3"><span class="s1"><b>CiSE (C in S-Expression)</b></span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(define-cfn main (argc :: int argv :: char **) :: int</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">   </span>(setlocale LC_ALL "")</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">   </span>(cond [(isatty STDOUT_FILENO)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">          </span>(= termwidth 80)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">          </span>(let * ([p :: char * (getenv "COLUMNS")]]</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">                 </span>[win: :( struct winsize)])</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">            </span>(cond [(and p (! = (* p) # \ null)) (= termwidth (atoi p))]</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">                  </span>[(and (! = (ioctl STDOUT_FILENO TIOCGWINSZ (&amp; win)) -1)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">                        </span>(&gt; (ref win ws _ color 0))</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">                   </span>(= termwidth (ref win ws _ color))])</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">            </span>(= f_nonprint 1))]</span></p>
<p class="p3"><span class="s1"><b>CiSE (C in S-Expression) (cont' d)</b></span></p>
<ul class="ul2">
  <li class="li1"><span class="s1">The C ABI, semantics remain intact</span></li>
  <ul class="ul3">
    <li class="li1"><span class="s1">You can use the runtime as it is</span></li>
    <li class="li1"><span class="s1">on the bare metal</span></li>
    <li class="li1"><span class="s1">Just a slight change in appearance</span></li>
  </ul>
  <li class="li1"><span class="s1">You can use genuine macros</span></li>
  <ul class="ul3">
    <li class="li1"><span class="s1">Any source code conversion possible before compiling</span></li>
  </ul>
  <li class="li1"><span class="s1">Unofficial support at Gauche</span></li>
</ul>
<p class="p3"><span class="s1"><b>macro</b></span></p>
<p class="p9"><span class="s1">Syntax tree substitution</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(define - cise - stmt (when test. body)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">   </span>`(if, test (begin, @ body)))</span></p>
<p class="p17"><span class="s1"></span><br></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">   </span>:</span></p>
<p class="p17"><span class="s1"></span><br></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(when (is-- foo x) (do-- this) (do-- that))</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s7">↓</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(if (is _ foo x) (begin (do_this) (do_that)))</span></p>
<p class="p17"><span class="s1"></span><br></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>; if (is_foo (x)) {do_this (); do_that ();}</span></p>
<p class="p3"><span class="s1"><b>Macro (cont'd)</b></span></p>
<p class="p9"><span class="s1">Pattern extraction / concealment</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(dotimes [i (strlen s)] (printf "% 02x" (aref si)))</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s7">↓</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(let * ([i :: int 0] [cise__ 213 :: int (strlen s)])</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">   </span>(for [() (&lt;i cise__ 213) (inc! i)]</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>(printf "% 02x" (aref si)))))</span></p>
<p class="p17"><span class="s1"></span><br></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>;; {</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>int i = 0; int cise__ 213 = strlen (s);</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>; for (; i &lt;cise__ 213; i ++) {</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>;; printf ("% 02x", s [i]);</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>;;}</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>;;}</span></p>
<p class="p3"><span class="s1"><b>Macro (cont'd)</b></span></p>
<p class="p9"><span class="s1">Global compile time calculation</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(define-enum FooMode (MODE_X MODE_Y))</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">   </span>:</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(gen-printer FooMode)</span></p>
<p class="p19"><span class="s1">↓</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>enum FooMode {MODE_X, MODE_Y};</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">   </span>:</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>void FooMode_print (enum FooMode m)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>{</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">   </span>switch (m) {</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>case MODE_X: puts ("MODE_X"); break;</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>case MODE_Y: puts ("MODE_Y"); break;</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">   </span>}</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>}</span></p>
<p class="p3"><span class="s1"><b>Modification 1 - removal of repeating pattern</b></span></p>
<p class="p15"><span class="s1">cmp.sc</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(define-cmpfn namecmp</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">   </span>(return (strcoll (-&gt; a fts_name) (-&gt; b fts _ name)))))</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(define-cmpfn-stat modcmp st_mtime)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(define-cmpfn-stat acccmp st_atime)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(define-cmpfn-stat statcmp st_ctime)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(define - cmpfn - stat sizecmp st - size)</span></p>
<p class="p3"><span class="s1"><b>Modification 1 - Removal of repeating pattern (cont' d)</b></span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space"> </span>FTSENT * p;</span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space">    </span>:</span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space"> </span>for (p = dp -&gt; list; p; p = p -&gt; fts_link) {</span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space">    </span>...</span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space"> </span>}</span></p>
<p class="p19"><span class="s1">↓</span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space"> </span>(do-ftsent [p (-&gt; dp list)] ...)</span></p>
<p class="p3"><span class="s1"><b>Modification 2 - Lifting essence</b></span></p>
<p class="p15"><span class="s1">util.sc</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(define-cfn prn_normal (s: :( const char *)) :: int</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">   </span>(let * ([n :: int 0])</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>(make-printer</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">      </span>(putchar (cast (unsigned char) (* s))); ilseq (clen == -1)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">      </span>(+ = n (printf "% s" s)); incomplete (clen == - 2)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">      </span>(default-print); nonprintable</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">      </span>(begin (default-print) (+ = n (wcwidth wc)))); printable</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>(return n)))</span></p>
<p class="p9"><span class="s1">Original C function: 29 LOC</span></p>
<p class="p3"><span class="s1"><b>Modification 2 - Start of essence (cont' d)</b></span></p>
<p class="p15"><span class="s1">util.sc</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(define-cfn prn_octal (s: :( const char *)) :: int</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">   </span>(let * ([len :: int 0]</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">          </span>[esc: :(. array (static const char) (())) "\ \ \ \ \" \ "\ aa \ bb \ f n \ rr \ tt \ vv"])</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>(make-printer</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">      </span>(octal-print 1); ilseq (clen == -1)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">      </span>(octal-print (strlen s)); incomplete (clen == -2)</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">      </span>(esc-print); nonprint</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">      </span>(if (and (! = wc (cast wchar_t # \ ")); print</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">               </span>(! = wc (cast wchar_t # \ \)))</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">        </span>(begin (default-print) (+ = len (wcwidth wc)))</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">        </span>(esc-print)))</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space">     </span>(return len)))</span></p>
<p class="p9"><span class="s1">Original C function: 50 LOC</span></p>
<p class="p3"><span class="s1"><b>Modification 3 - DSL</b></span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(define-flag int f_accesstime "u" "cU"); use time of last access</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(define-flag int f_statustime "c" "uU"); use time of last mode change</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(define-flag int f_longform "l" "1 Cxm"); long listing format</span></p>
<p class="p16"><span class="s1"><span class="Apple-converted-space"> </span>(define-flag int f_nonprint "q" "Bbw"); show unprintables as?</span></p>
<ul class="ul2">
  <li class="li1"><span class="s1">Generate variable definition on the spot</span></li>
  <li class="li1"><span class="s1">Generate option handler in option parser</span></li>
  <li class="li1"><span class="s1">Generate variable declaration in another file</span></li>
  <li class="li1"><span class="s1">13 lines of macro code</span></li>
</ul>
<p class="p3"><span class="s1"><b>Comparison</b></span></p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td3">
        <p class="p20"><span class="s1"><b></b></span><br></p>
      </td>
      <td valign="middle" class="td4">
        <p class="p11"><span class="s1"><b>Before</b></span></p>
      </td>
      <td valign="middle" class="td5">
        <p class="p11"><span class="s1"><b>After</b></span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td3">
        <p class="p14"><span class="s1">cmp.c</span></p>
      </td>
      <td valign="middle" class="td4">
        <p class="p13"><span class="s1">73</span></p>
      </td>
      <td valign="middle" class="td5">
        <p class="p13"><span class="s1">15</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td3">
        <p class="p14"><span class="s1">ls.c</span></p>
      </td>
      <td valign="middle" class="td4">
        <p class="p13"><span class="s1">526</span></p>
      </td>
      <td valign="middle" class="td5">
        <p class="p13"><span class="s1">277</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td3">
        <p class="p14"><span class="s1">print.c</span></p>
      </td>
      <td valign="middle" class="td4">
        <p class="p13"><span class="s1">319</span></p>
      </td>
      <td valign="middle" class="td5">
        <p class="p13"><span class="s1">183</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td3">
        <p class="p14"><span class="s1">util.c</span></p>
      </td>
      <td valign="middle" class="td4">
        <p class="p13"><span class="s1">164</span></p>
      </td>
      <td valign="middle" class="td5">
        <p class="p13"><span class="s1">73</span></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td3">
        <p class="p14"><span class="s1">Total</span></p>
      </td>
      <td valign="middle" class="td4">
        <p class="p13"><span class="s1">1082</span></p>
      </td>
      <td valign="middle" class="td5">
        <p class="p13"><span class="s1">548</span></p>
      </td>
    </tr>
  </tbody>
</table>
<ul class="ul2">
  <li class="li1"><span class="s1">The code is about half (effect is larger if the original code is bigger)</span></li>
  <li class="li1"><span class="s1">Aggregate meanings </span><span class="s8">→</span><span class="s1"> easy to add functions of the same line</span></li>
  <li class="li1"><span class="s1">Pattern reusability</span></li>
</ul>
<p class="p3"><span class="s1"><b>CAUTION</b></span></p>
<p class="p21"><span class="s1">!!Caution!!</span></p>
<ul class="ul2">
  <li class="li1"><span class="s1">It is not a story that "CiSE / Macro can be used"</span></li>
  <li class="li1"><span class="s1">Macro is a powerful medicine </span><span class="s8">→</span><span class="s1"> Be familiar with usage</span></li>
  <li class="li1"><span class="s1">CiSE is an experimental stage</span></li>
</ul>
<p class="p3"><span class="s1"><b>CAUTION (cont' d)</b></span></p>
<p class="p22"><span class="s1">`` Macro Club has two rules, plus one exception ''</span></p>
<ol class="ol1">
  <li class="li1"><span class="s1">Do not write macros.</span></li>
  <li class="li1"><span class="s1">If it's the only way to encapsulate the pattern, write a macro</span></li>
  <li class="li1"><span class="s1">Compared to equivalent functions, if the caller becomes easy, you can write macros</span></li>
</ol>
<p class="p23"><span class="s1"><i>Stuart Halloway ("Programming Clojure")</i></span></p>
<p class="p3"><span class="s1"><b>Message from the Takumi</b></span></p>
<p class="p10"><span class="s1">You are a programmer, rather than being used for a versatile god language, play with the language using language</span></p>
</body>
</html>
